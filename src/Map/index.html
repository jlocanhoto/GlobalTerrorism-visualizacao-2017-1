<!DOCTYPE html>
<meta charset="utf-8">
<style>
</style>
<body>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.1.0/dist/leaflet.css"
    integrity="sha512-wcw6ts8Anuw10Mzh9Ytw4pylW8+NAD4ch3lqm9lzAsTxg0GFeJgoAtxuCLREZSC5lUXdVyo/7yfsqFjQ4S+aKw=="
    crossorigin=""/>
  <script src="https://unpkg.com/leaflet@1.1.0/dist/leaflet.js"
    integrity="sha512-mNqn2Wg7tSToJhvHcqfzLMU6J4mkOImSPTxVZAdo+lcPlk+GhZmYgACEe0x35K7YzW1zJ7XyJV/TT1MrdXvMcA=="
    crossorigin=""></script>
  <script src="https://d3js.org/d3.v4.min.js"></script>
  <script src="leaflet-heat.js"></script>
  <script src="palette.js"></script>
  <script src="capitals.js"></script>
  <script src="Map.js"></script>
  <script>

      d3.csv("https://raw.githubusercontent.com/jlocx/GlobalTerrorism-visualizacao-2017-1/master/datasets/selectedGTD.csv", convert, function(err, data){
          if(err) throw err;

          // var gnames = ["Taliban", "Islamic State of Iraq and the Levant (ISIL)"];
          var gnames = ["Taliban"];
          //var gnames = ["Irish Republican Army (IRA)"];
          //var gnames = ["Al-Shabaab"];
          // var gnames = ["Islamic State of Iraq and the Levant (ISIL)"];

          var dimensions = {width: 960, height: 600};
          var position = {x: 0, y: 0};
          var map = new Map(dimensions, position, "map", gnames.length);
          var dScale = d3.scaleLinear( ).range([0., 1.]);

          var deaths = [ ];
          var groups = [ ];

          gnames.forEach(function(g){
              var group = data.filter(function(d){
                              return d.gname == g;
                          });

              var death = group.map(function(d){
                              var num = d.nkill;
                              if(!num) num = 0;
                              return num;
                          });

              groups.push(group);
              deaths.push(death);

          });

          var flatten = [ ].concat.apply([ ], groups);
          var years = d3.extent(flatten.map(function(d){ return d.iyear; }));
          var months = Array.from(Array(12).keys( ));

          var attacks = [ ];

          for(var i = years[0]; i <= years[1]; i++){
              var groups_year = [ ];
              var groups_month = [ ];

              groups.forEach(function(group){
                  var group_year = [ ];

                  group_year = group.filter(function(g){
                                    return g.iyear == i;
                               });

                  groups_year.push(group_year);
              });

              months.forEach(function(m){
                  var month = [ ];

                  groups_year.forEach(function(group_year){
                      group_month = group_year.filter(function(g){
                          return g.imonth == m + 1;
                      });

                      month.push(group_month);

                  });

                  groups_month.push(month);
              });

              groups_month.forEach(function(group_month){
                  var attacks_month = [ ];

                  group_month.forEach(function(group, i){
                      var attack = [ ];

                      group.forEach(function(g){
                          dScale.domain(d3.extent(deaths[i]));
                          attack.push([g.latitude, g.longitude, dScale(g.nkill)]);
                      });

                      attacks_month.push(attack);
                  });

                  attacks.push(attacks_month);
              });
          }

          map.show(capitals["Taliban"], 6);

          attacks.forEach(function(groups, i){
              groups.forEach(function(attack, j){

                  setTimeout(function( ){
                      map.heatmap(attack, j);
                  }, i * 100);
              });
          });

      });

      function convert(d){
          d.iyear = +d.iyear;
          d.imonth = +d.imonth;
          d.nkill = +d.nkill;
          d.latitude = +d.latitude;
          d.longitude = +d.longitude;

          return d;
      }

  </script>

  <div id = "map"></div>
</body>
